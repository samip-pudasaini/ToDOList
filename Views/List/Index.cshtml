@model ToDoList.ViewModel.TaskListViewModel

@{
    ViewData["Title"] = "TO DO List";
}

<div class="todo-container row">
    <!--List Panel-->
    <div class="lists-panel col-2 bg-body-tertiary border border-light-subtle rounded-4 shadow-sm p-3
            position-relative"
         style="height: 80vh; overflow-y: auto;">

        <h3 class="text-center text-secondary mb-3">Lists</h3>
        <hr />

        <div class="list-panel-row row">
            @if (Model?.List != null)
            {
                foreach (var ListItem in Model.List)
                {
                    <a asp-controller="List" asp-action="selectedList" asp-route-id="@ListItem.ListId" class="list-group-item p-2 mb-2 bg-white rounded">
                        <strong>@ListItem.Name</strong>
                    </a>
                }
            }
        </div>

        <!-- Bottom pinned item -->
        <div class="list-panel-bottom position-absolute bottom-0
                p-2 mb-2 g-white rounded" style="width: 85%">
            <form asp-action="Create" asp-controller="List" method="post">
                <input type="text" name="Name" class="AddList form-control"
                    placeholder="Add new list" />
            </form>
        </div>
    </div>


    <!--Task Panel-->
    <div class="tasks-panel ms-4 col col-gap-2 bg-body-tertiary border border-light-subtle rounded-4 shadow-sm p-3 position-relative" style="height: 80vh; overflow-y: auto;">
        <h3 class="text-center text-secondary mb-3">Tasks</h3>
        <hr />
        <div class="list-panel-row row">
            @if (Model?.Tasks != null && Model.Tasks.Any())
            {
                foreach (var TaskItem in Model.Tasks)
                {
                    <div class="task-item task-clickable p-2 mb-2 bg-white rounded"
                        data-task-id="@TaskItem.TaskId"
                        style="cursor: pointer;">
                        
                            
                        <strong>
                            @if (TaskItem.IsCompleted)
                            {
                                <s>@TaskItem.Title</s>
                            }
                            else
                            {
                                @TaskItem.Title
                            }
                        </strong>

                            @if (!string.IsNullOrEmpty(TaskItem.Description))
                            {
                                <p class="mb-1 text-muted small">@TaskItem.Description</p>
                            }
                            <small class="text-secondary">
                                Priority: @TaskItem.Priority | Due: @TaskItem.DueDate.ToShortDateString()
                            </small>
                    </div>
                }
            }
        </div>

        <!-- Bottom pinned item -->
        <div class="list-panel-bottom position-absolute bottom-0
                p-2 mb-2 g-white rounded" style="width: 85%">
            <form asp-action="Create" asp-controller="Task" method="post">
                <input type="hidden" name="ListId" value="@Model.SelectedList?.ListId" />
                <input type="text" name="Title" class="AddTask form-control"
                       placeholder="Add new Task" />
            </form>
        </div>
    </div>

    <!-- Sidebar for task details -->
    <div id="taskSidebar" class="position-fixed top-0 end-0 bg-white shadow-lg"
         style="width: 450px; height: 100vh; display: none; z-index: 1050; overflow-y: auto;">
        <div class="p-3">
            <button id="closeSidebar" class="btn btn-close float-end"></button>
            <div id="sidebarContent" class="mt-4">
                <!-- Partial view loads here -->
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        //Get task items
        const taskItems = document.querySelectorAll(".task-clickable");

        //Add click listener to each
        taskItems.forEach( taskItems => {
                taskItems.addEventListener('click', function(){
                    //get task ID
                    const taskId = this.getAttribute("data-task-id");

                    //call function to load sidebar
                    loadTaskSidebar(taskId);
                });
        });
        
        //fetch and load sidebar
        function loadTaskSidebar(taskId) {
            fetch(`/Task/GetTaskDetails?id=${taskId}`)
                .then(response => response.text())
                .then(html => {
                    console.log("Response:", html); // <-- check this in the browser console
                    if (html.startsWith("Error:")) {
                        alert(html);
                        return;
                    }
                    document.getElementById('sidebarContent').innerHTML = html;
                    document.getElementById('taskSidebar').style.display = 'block';
                })
                .catch(err => {
                    console.error(err);
                    alert("Could not load task details.");
                });
        }


        //close button
        function closeSidebar() {
            document.getElementById('taskSidebar').style.display = 'none';
        }

        document.getElementById('closeSidebar').addEventListener('click', closeSidebar);
    </script>
}